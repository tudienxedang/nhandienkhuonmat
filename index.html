<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>AI FaceID - Cloud Sync</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <style>
        :root { 
            --bg: #0f172a; 
            --surface: #1e293b; 
            --primary: #3b82f6; 
            --success: #10b981; 
            --danger: #ef4444; 
            --warning: #f59e0b; 
            --text: #f8fafc;
            --text-secondary: #94a3b8;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; 
        }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow-x: hidden; 
        }
        
        /* HEADER */
        .app-header { 
            padding: 14px 16px; 
            background: var(--surface); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #334155; 
            flex-shrink: 0; 
            min-height: 64px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .brand { 
            font-weight: 800; 
            color: var(--primary); 
            font-size: clamp(18px, 5vw, 20px);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-pill { 
            font-size: clamp(11px, 3vw, 13px); 
            padding: 6px 14px; 
            border-radius: 20px; 
            background: #334155; 
            color: var(--text-secondary); 
            font-weight: 600; 
            transition: all 0.3s ease; 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            white-space: nowrap;
            min-width: max-content;
        }
        
        .status-pill.scanning { 
            background: var(--warning); 
            color: #000; 
            animation: pulse 1.5s infinite; 
        }
        
        .status-pill.locked { 
            background: var(--success); 
            color: white; 
        }
        
        .status-pill.syncing { 
            background: var(--primary); 
            color: white; 
        }
        
        @keyframes pulse { 
            0% { opacity: 0.7; } 
            50% { opacity: 1; } 
            100% { opacity: 0.7; } 
        }
        
        /* MAIN CAMERA AREA - FIXED CANVAS */
        .camera-container { 
            flex: 1; 
            position: relative; 
            background: #000; 
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            min-height: 300px;
        }
        
        .video-wrapper { 
            position: relative; 
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        video { 
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror effect for video only */
            display: block;
            background: #000;
        }
        
        canvas { 
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            /* Canvas kh√¥ng b·ªã mirror - ch·ªâ video b·ªã mirror */
            pointer-events: none;
            z-index: 2;
        }
        
        /* PLACEHOLDER */
        .camera-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
            text-align: center;
            padding: 20px;
            z-index: 1;
        }
        
        /* SCAN RADAR */
        .scan-radar { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: min(220px, 65vw); 
            height: min(220px, 65vw); 
            border: 2px solid rgba(59, 130, 246, 0.3); 
            border-radius: 50%; 
            display: none; 
            z-index: 1;
        }
        
        .scan-radar::after { 
            content: ''; 
            position: absolute; 
            inset: 0; 
            border-radius: 50%; 
            border-top: 2px solid var(--primary); 
            animation: radar-spin 2s linear infinite; 
        }
        
        @keyframes radar-spin { 
            to { transform: rotate(360deg); } 
        }
        
        /* LIVENESS BADGE */
        .liveness-badge { 
            position: absolute; 
            top: 15px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: rgba(0,0,0,0.85); 
            color: white; 
            padding: 10px 20px; 
            border-radius: 30px; 
            font-size: clamp(13px, 3.5vw, 14px); 
            font-weight: 600; 
            border: 1px solid rgba(255,255,255,0.2); 
            opacity: 0; 
            transition: all 0.3s ease; 
            pointer-events: none;
            z-index: 10;
            white-space: nowrap;
            max-width: 90%;
            text-overflow: ellipsis;
            overflow: hidden;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .liveness-badge.show { 
            opacity: 1; 
            top: 25px; 
        }
        
        /* INFO PANEL */
        .info-panel { 
            position: absolute; 
            bottom: 15px; 
            left: 15px; 
            right: 15px; 
            background: rgba(15, 23, 42, 0.95); 
            backdrop-filter: blur(15px); 
            border-radius: 16px; 
            padding: 18px; 
            border-left: 6px solid var(--success); 
            box-shadow: 0 8px 32px rgba(0,0,0,0.4); 
            transform: translateY(150%); 
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
            display: flex; 
            flex-direction: column; 
            gap: 10px;
            z-index: 10;
            max-height: 45vh;
            overflow-y: auto;
        }
        
        .info-panel.show { transform: translateY(0); }
        .info-panel.error { border-left-color: var(--danger); }
        
        .user-name { 
            font-size: clamp(18px, 5vw, 22px); 
            font-weight: 800; 
            color: white; 
            margin-bottom: 4px; 
            white-space: normal;
            word-break: break-word;
            line-height: 1.3;
        }
        
        .info-row { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            color: #cbd5e1; 
            font-size: clamp(13px, 3.5vw, 15px); 
            padding: 6px 0; 
            border-bottom: 1px solid rgba(255,255,255,0.08); 
            line-height: 1.4;
        }
        
        .info-row:last-child { border-bottom: none; }
        
        .info-row i { 
            width: 20px; 
            text-align: center; 
            color: var(--primary); 
            flex-shrink: 0;
        }
        
        /* CONTROLS */
        .controls { 
            padding: 16px; 
            background: var(--surface); 
            flex-shrink: 0; 
            display: flex; 
            flex-direction: column; 
            gap: 14px; 
            border-top: 1px solid #334155;
        }
        
        .main-btns { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
        }
        
        .btn { 
            border: none; 
            padding: 16px; 
            border-radius: 12px; 
            font-weight: 700; 
            color: white; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            font-size: clamp(15px, 4vw, 17px);
            min-height: 54px;
            touch-action: manipulation;
            transition: all 0.2s ease;
            user-select: none;
        }
        
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
        
        .btn-start { background: var(--primary); }
        .btn-stop { background: var(--danger); }
        .btn-retry { background: var(--warning); margin-top: 10px; }
        
        .settings-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            color: var(--text-secondary); 
            font-size: clamp(13px, 3.5vw, 14px);
            flex-wrap: wrap;
            gap: 12px;
        }
        
        /* MEDIA QUERIES */
        @media (orientation: landscape) and (max-height: 500px) {
            .camera-container { min-height: 70vh; }
            .controls { flex-direction: row; align-items: center; padding: 12px 16px; }
            .main-btns { grid-template-columns: 1fr; gap: 8px; min-width: 130px; }
            .settings-bar { flex-direction: column; align-items: flex-start; gap: 8px; flex: 1; }
            .info-panel { max-height: 35vh; bottom: 10px; left: 10px; right: 10px; }
            .liveness-badge { top: 10px; font-size: 12px; padding: 8px 16px; }
        }
    </style>
</head>
<body>
    <!-- LOADING SCREEN -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: #94a3b8; text-align: center; padding: 0 20px; font-size: 16px;">
            ƒêang t·∫£i AI Model v√† Camera...
        </p>
    </div>

    <!-- ERROR STATE -->
    <div class="error-state" id="errorState" style="display: none; position: fixed; inset: 0; background: var(--bg); z-index: 9998; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center;">
        <i class="fas fa-video-slash" style="font-size: 64px; color: var(--danger); margin-bottom: 20px;"></i>
        <h2 style="font-size: 24px; margin-bottom: 10px; color: var(--text);">Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông Camera</h2>
        <p id="errorMessage" style="color: var(--text-secondary); margin-bottom: 20px; line-height: 1.5;">
            ƒê√£ x·∫£y ra l·ªói khi truy c·∫≠p camera. Vui l√≤ng ki·ªÉm tra v√† th·ª≠ l·∫°i.
        </p>
        <button class="btn btn-retry" onclick="retryCamera()">
            <i class="fas fa-redo"></i> Th·ª≠ l·∫°i Camera
        </button>
    </div>

    <!-- HEADER -->
    <div class="app-header">
        <div class="brand"><i class="fas fa-scan"></i> FaceID Pro</div>
        <div class="status-pill" id="systemStatus">S·∫µn s√†ng</div>
    </div>

    <!-- MAIN CAMERA AREA -->
    <div class="camera-container">
        <div class="video-wrapper">
            <video id="video" autoplay muted playsinline></video>
            <canvas id="overlay"></canvas>
            
            <!-- CAMERA PLACEHOLDER -->
            <div class="camera-placeholder" id="cameraPlaceholder">
                <i class="fas fa-video"></i>
                <h3 style="font-size: 18px; margin-bottom: 10px; color: var(--text);">Camera ƒëang t·∫£i...</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">ƒêang kh·ªüi ƒë·ªông camera, vui l√≤ng ƒë·ª£i</p>
                <div class="spinner" style="width: 30px; height: 30px; margin-top: 10px;"></div>
            </div>
            
            <!-- SCAN RADAR -->
            <div class="scan-radar" id="radar"></div>

            <!-- LIVENESS BADGE -->
            <div class="liveness-badge" id="livenessBadge">
                <i class="far fa-eye"></i> Vui l√≤ng ch·ªõp m·∫Øt
            </div>

            <!-- INFO PANEL -->
            <div class="info-panel" id="infoPanel"></div>
        </div>
    </div>

    <!-- CONTROLS -->
    <div class="controls">
        <div class="main-btns">
            <button class="btn btn-start" id="startBtn" disabled onclick="toggleSystem(true)">
                <i class="fas fa-play"></i> B·∫Øt ƒë·∫ßu
            </button>
            <button class="btn btn-stop" id="stopBtn" disabled onclick="toggleSystem(false)">
                <i class="fas fa-stop"></i> D·ª´ng
            </button>
        </div>
        
        <div class="settings-bar">
            <label class="checkbox-container" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="livenessCheck" checked> 
                <span>Ch·ªëng gi·∫£ m·∫°o</span>
            </label>
            
            <button class="sync-btn" onclick="syncDataFromDrive()" style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: var(--primary); cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: clamp(13px, 3.5vw, 14px); padding: 10px 14px; border-radius: 8px; transition: all 0.2s ease; font-weight: 600;">
                <i class="fas fa-sync-alt"></i> ƒê·ªìng b·ªô Drive (<span id="dbCount">0</span>)
            </button>
        </div>
    </div>

    <script>
        // ========================================================
        // CONFIGURATION
        // ========================================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbwp5wxyR_ZV-1TMelVPGDLFNKAqfWd1ZjT43tJejXdUD2JRM4AUok0q53WeegmoNa0qQg/exec';
        
        const CONFIG = {
            MODEL_URL: 'https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js@0.22.2/weights',
            DETECTOR: new faceapi.TinyFaceDetectorOptions({ 
                inputSize: window.innerWidth < 768 ? 160 : 320, 
                scoreThreshold: 0.5 
            }),
            MATCH_THRESHOLD: 0.5,
            
            // Camera configuration
            CAMERA_CONSTRAINTS: [
                { video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 }, frameRate: { ideal: 30 } } },
                { video: { width: { min: 320, ideal: 640, max: 1280 }, height: { min: 240, ideal: 480, max: 720 }, frameRate: { ideal: 24 } } },
                { video: true }
            ],
            
            // Liveness Detection Configuration - THE ORIGINAL SETTINGS
            BLINK_THRESHOLD: 0.28,  // GI·ªÆ NGUY√äN NH∆Ø CODE G·ªêC
            EYE_OPEN_THRESHOLD: 0.30
        };

        // ========================================================
        // STATE MANAGEMENT - THE ORIGINAL STRUCTURE
        // ========================================================
        let state = {
            db: null,
            faceMatcher: null,
            users: [],
            isRunning: false,
            loopId: null,
            cameraStream: null,
            cameraRetryCount: 0,
            maxCameraRetries: 3,
            
            // THE ORIGINAL LIVENESS STATE - ƒê√öNG NH∆Ø CODE G·ªêC
            blinkDetected: false,  // CH·ªà 1 BI·∫æN ƒê∆†N GI·∫¢N
            noFaceTimer: null
        };

        // ========================================================
        // DOM ELEMENTS
        // ========================================================
        const video = document.getElementById('video');
        const canvas = document.getElementById('overlay');
        const infoPanel = document.getElementById('infoPanel');
        const statusBadge = document.getElementById('systemStatus');
        const radar = document.getElementById('radar');
        const livenessBadge = document.getElementById('livenessBadge');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const loader = document.getElementById('loader');
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        const cameraPlaceholder = document.getElementById('cameraPlaceholder');

        // ========================================================
        // DATABASE FUNCTIONS
        // ========================================================
        async function initDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open('FaceID_Cloud_Sync', 1);
                
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('profiles')) {
                        db.createObjectStore('profiles', { keyPath: 'name' });
                    }
                };
                
                req.onsuccess = (e) => {
                    state.db = e.target.result;
                    loadUsers();
                    resolve();
                };
                
                req.onerror = (e) => {
                    console.error('IndexedDB error:', e.target.error);
                    reject(e.target.error);
                };
            });
        }

        function loadUsers() {
            if (!state.db) return;
            
            const transaction = state.db.transaction('profiles', 'readonly');
            const store = transaction.objectStore('profiles');
            const request = store.getAll();
            
            request.onsuccess = (e) => {
                state.users = e.target.result;
                document.getElementById('dbCount').innerText = state.users.length;
                
                if (state.users.length > 0) {
                    const labeledDescriptors = state.users.map(user => 
                        new faceapi.LabeledFaceDescriptors(
                            user.name, 
                            user.descriptors.map(desc => new Float32Array(desc))
                        )
                    );
                    
                    state.faceMatcher = new faceapi.FaceMatcher(
                        labeledDescriptors, 
                        CONFIG.MATCH_THRESHOLD
                    );
                } else {
                    state.faceMatcher = null;
                }
            };
        }

        // ========================================================
        // CAMERA FUNCTIONS
        // ========================================================
        async function startCamera() {
            try {
                cameraPlaceholder.style.display = 'flex';
                video.style.display = 'none';
                
                let stream = null;
                let lastError = null;
                
                // Try each constraint
                for (let i = 0; i < CONFIG.CAMERA_CONSTRAINTS.length; i++) {
                    const constraints = CONFIG.CAMERA_CONSTRAINTS[i];
                    
                    try {
                        const timeoutPromise = new Promise((_, reject) => {
                            setTimeout(() => reject(new Error('Camera timeout')), 8000);
                        });
                        
                        const mediaPromise = navigator.mediaDevices.getUserMedia(constraints);
                        stream = await Promise.race([mediaPromise, timeoutPromise]);
                        break;
                        
                    } catch (err) {
                        lastError = err;
                        if (stream) stream.getTracks().forEach(track => track.stop());
                    }
                }
                
                if (!stream) throw lastError || new Error('Cannot access camera');
                
                state.cameraStream = stream;
                video.srcObject = stream;
                
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => resolve();
                    setTimeout(() => resolve(), 2000);
                });
                
                video.style.display = 'block';
                cameraPlaceholder.style.display = 'none';
                canvas.width = video.videoWidth || 640;
                canvas.height = video.videoHeight || 480;
                
                state.cameraRetryCount = 0;
                loader.style.display = 'none';
                errorState.style.display = 'none';
                startBtn.disabled = false;
                
            } catch (error) {
                console.error('Camera error:', error);
                
                if (state.cameraStream) {
                    state.cameraStream.getTracks().forEach(track => track.stop());
                    state.cameraStream = null;
                }
                
                showCameraError(error);
            }
        }

        function showCameraError(error) {
            loader.style.display = 'none';
            errorState.style.display = 'flex';
            cameraPlaceholder.style.display = 'none';
            
            let message = 'L·ªói camera: ';
            if (error.name === 'NotAllowedError') message += 'B·ªã t·ª´ ch·ªëi quy·ªÅn';
            else if (error.name === 'NotFoundError') message += 'Kh√¥ng t√¨m th·∫•y camera';
            else if (error.name === 'AbortError') message += 'Timeout';
            else message += error.message;
            
            errorMessage.textContent = message;
        }

        function retryCamera() {
            if (state.cameraRetryCount >= state.maxCameraRetries) return;
            state.cameraRetryCount++;
            errorState.style.display = 'none';
            loader.style.display = 'flex';
            setTimeout(startCamera, 1000);
        }

        // ========================================================
        // LIVENESS DETECTION - THE ORIGINAL CODE (FIXED)
        // ========================================================
        function getEAR(eye) {
            // ƒê√ÇY L√Ä C√îNG TH·ª®C G·ªêC - ƒê·ª™NG THAY ƒê·ªîI
            const d1 = Math.hypot(eye[1].x - eye[5].x, eye[1].y - eye[5].y);
            const d2 = Math.hypot(eye[2].x - eye[4].x, eye[2].y - eye[4].y);
            const d3 = Math.hypot(eye[0].x - eye[3].x, eye[0].y - eye[3].y);
            return (d1 + d2) / (2 * d3);
        }

        // ========================================================
        // CORE SYSTEM FUNCTIONS - THE ORIGINAL LOGIC
        // ========================================================
        async function init() {
            try {
                await initDB();
                
                // Load AI models
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(CONFIG.MODEL_URL),
                    faceapi.nets.faceLandmark68TinyNet.loadFromUri(CONFIG.MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(CONFIG.MODEL_URL)
                ]);
                
                console.log('‚úÖ AI Models loaded');
                
                // Start camera
                await startCamera();
                
                // Auto-sync
                setTimeout(syncDataFromDrive, 1000);
                
            } catch (error) {
                console.error('Init error:', error);
            }
        }

        function toggleSystem(active) {
            state.isRunning = active;
            startBtn.disabled = active;
            stopBtn.disabled = !active;
            
            if (active) {
                radar.style.display = 'block';
                statusBadge.innerText = "ƒêang qu√©t...";
                statusBadge.className = "status-pill scanning";
                
                // Reset liveness state
                state.blinkDetected = false;
                
                runLoop();
            } else {
                cancelAnimationFrame(state.loopId);
                if (canvas.getContext) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
                resetToIdle();
            }
        }

        async function runLoop() {
            if (!state.isRunning) return;
            
            if (!video.videoWidth || !video.videoHeight) {
                state.loopId = requestAnimationFrame(runLoop);
                return;
            }
            
            const displaySize = { width: video.videoWidth, height: video.videoHeight };
            faceapi.matchDimensions(canvas, displaySize);
            
            try {
                const detections = await faceapi.detectAllFaces(
                    video, 
                    CONFIG.DETECTOR
                ).withFaceLandmarks(true).withFaceDescriptors();
                
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const useLiveness = document.getElementById('livenessCheck').checked;
                
                if (resizedDetections.length > 0) {
                    radar.style.display = 'none';
                    
                    const detection = resizedDetections[0];
                    const box = detection.detection.box;
                    let isReal = false;
                    
                    // ============================================
                    // THE ORIGINAL LIVENESS DETECTION CODE - FIXED
                    // ============================================
                    if (useLiveness) {
                        const ear = (getEAR(detection.landmarks.getLeftEye()) + getEAR(detection.landmarks.getRightEye())) / 2;
                        
                        console.log("EAR Value:", ear); // Debug log
                        
                        // FIX 1: TH√äM ƒêI·ªÄU KI·ªÜN ƒê·ªÇ D·ªÑ PH√ÅT HI·ªÜN CH·ªöP M·∫ÆT
                        if (ear < CONFIG.BLINK_THRESHOLD) {
                            state.blinkDetected = true;
                            console.log("Blink detected! EAR:", ear); // Debug log
                        }
                        
                        // FIX 2: HI·ªÇN TH·ªä TR·∫†NG TH√ÅI
                        if (state.blinkDetected) {
                            isReal = true;
                            showLivenessBadge(true);
                        } else {
                            showLivenessBadge(false);
                        }
                    } else {
                        isReal = true;
                        livenessBadge.classList.remove('show');
                    }
                    
                    // ============================================
                    // FIX CANVAS MIRRORING - QUAN TR·ªåNG!
                    // ============================================
                    // Video b·ªã mirror, nh∆∞ng landmarks kh√¥ng b·ªã mirror
                    // V√¨ v·∫≠y, ch√∫ng ta c·∫ßn ƒëi·ªÅu ch·ªânh t·ªça ƒë·ªô box
                    const mirroredBox = {
                        x: canvas.width - box.x - box.width, // Mirror horizontally
                        y: box.y,
                        width: box.width,
                        height: box.height
                    };
                    
                    const boxColor = isReal ? '#10b981' : '#f59e0b';
                    new faceapi.draw.DrawBox(mirroredBox, {
                        label: " ",
                        boxColor: boxColor,
                        lineWidth: 2
                    }).draw(canvas);
                    
                    // Face recognition
                    if (isReal && state.faceMatcher) {
                        const match = state.faceMatcher.findBestMatch(detection.descriptor);
                        showInfoResult(match.label);
                    }
                    
                } else {
                    // No face detected
                    radar.style.display = 'block';
                    statusBadge.innerText = "ƒêang t√¨m ki·∫øm...";
                    statusBadge.className = "status-pill scanning";
                    infoPanel.classList.remove('show');
                    livenessBadge.classList.remove('show');
                    
                    // FIX 3: RESET BLINK DETECTION KHI KH√îNG C√ì M·∫∂T
                    state.blinkDetected = false;
                }
                
            } catch (error) {
                console.error('Run loop error:', error);
            }
            
            state.loopId = requestAnimationFrame(runLoop);
        }

        function showLivenessBadge(success) {
            livenessBadge.classList.add('show');
            if (success) {
                livenessBadge.innerHTML = '<i class="fas fa-check"></i> X√°c th·ª±c OK';
                livenessBadge.style.color = 'var(--success)';
                livenessBadge.style.borderColor = 'var(--success)';
            } else {
                livenessBadge.innerHTML = '<i class="far fa-eye"></i> H√£y ch·ªõp m·∫Øt';
                livenessBadge.style.color = 'white';
                livenessBadge.style.borderColor = 'rgba(255,255,255,0.2)';
            }
        }

        function showInfoResult(label) {
            if (infoPanel.dataset.currentUser === label && infoPanel.classList.contains('show')) return;
            
            infoPanel.dataset.currentUser = label;
            infoPanel.classList.add('show');
            
            if (label === 'unknown') {
                infoPanel.className = 'info-panel show error';
                infoPanel.innerHTML = `
                    <div class="user-name">C·∫¢NH B√ÅO: NG∆Ø·ªúI L·∫†</div>
                    <div class="info-row">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Kh√¥ng c√≥ d·ªØ li·ªáu trong h·ªá th·ªëng.</span>
                    </div>
                `;
            } else {
                const user = state.users.find(u => u.name === label);
                if (user) {
                    infoPanel.className = 'info-panel show';
                    infoPanel.innerHTML = `
                        <div class="user-name">${user.name}</div>
                        <div class="info-row">
                            <i class="fas fa-id-badge"></i>
                            <span>ID: ${user.id}</span>
                        </div>
                        <div class="info-row">
                            <i class="fas fa-layer-group"></i>
                            <span>ƒê∆°n v·ªã: ${user.class}</span>
                        </div>
                        <div class="info-row" style="color: var(--success); font-weight: 600;">
                            <i class="fas fa-check-circle"></i>
                            <span>ƒêi·ªÉm danh th√†nh c√¥ng</span>
                        </div>
                    `;
                }
            }
        }

        function resetToIdle() {
            radar.style.display = 'none';
            statusBadge.innerText = "S·∫µn s√†ng";
            statusBadge.className = "status-pill";
            infoPanel.classList.remove('show');
            livenessBadge.classList.remove('show');
            
            // Reset liveness
            state.blinkDetected = false;
        }

        // ========================================================
        // GOOGLE DRIVE SYNC
        // ========================================================
        async function syncDataFromDrive() {
            if (!API_URL || API_URL.includes("D√ÅN_URL")) {
                alert("‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh URL Google Script.");
                return;
            }

            statusBadge.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i d·ªØ li·ªáu Cloud...';
            statusBadge.className = "status-pill syncing";

            try {
                const response = await fetch(API_URL);
                const cloudData = await response.json();

                if (!Array.isArray(cloudData)) throw new Error("D·ªØ li·ªáu tr·∫£ v·ªÅ l·ªói");

                const tx = state.db.transaction('profiles', 'readwrite');
                const store = tx.objectStore('profiles');

                let count = 0;
                for (const user of cloudData) {
                    const des = user.records
                        .filter(r => r.descriptor)
                        .map(r => new Float32Array(Object.values(r.descriptor)));
                    
                    if (des.length > 0) {
                        store.put({
                            ...user.user_profile,
                            descriptors: des,
                            timestamp: Date.now()
                        });
                        count++;
                    }
                }

                tx.oncomplete = () => {
                    console.log(`‚úÖ ƒê√£ ƒë·ªìng b·ªô ${count} ng∆∞·ªùi t·ª´ Google Drive.`);
                    loadUsers();
                    
                    statusBadge.innerText = "ƒê√£ ƒë·ªìng b·ªô xong";
                    statusBadge.className = "status-pill locked";
                    
                    setTimeout(() => {
                        statusBadge.innerText = "S·∫µn s√†ng";
                        statusBadge.className = "status-pill";
                    }, 2000);
                };

            } catch (err) {
                console.error("L·ªói Sync:", err);
                statusBadge.innerText = "L·ªói ƒë·ªìng b·ªô";
                statusBadge.className = "status-pill";
                alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ Drive.");
            }
        }

        // ========================================================
        // UTILITY FUNCTIONS
        // ========================================================
        let lastSpeak = 0;
        function speak(txt) {
            const now = Date.now();
            if (now - lastSpeak > 4000) {
                window.speechSynthesis.speak(new SpeechSynthesisUtterance(txt));
                lastSpeak = now;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--surface)'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 1000;
                font-weight: 500;
                animation: slideIn 0.3s ease;
                max-width: 300px;
                display: flex;
                align-items: center;
                gap: 10px;
            `;
            
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // ========================================================
        // EVENT LISTENERS
        // ========================================================
        window.addEventListener('resize', function() {
            if (video.videoWidth && video.videoHeight) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            }
        });
        
        window.addEventListener('beforeunload', function() {
            if (state.isRunning) toggleSystem(false);
            if (state.cameraStream) {
                state.cameraStream.getTracks().forEach(track => track.stop());
            }
        });
        
        document.addEventListener('DOMContentLoaded', init);

        console.log('üì± AI FaceID Pro - Original Liveness Detection');

    </script>
</body>
</html>
