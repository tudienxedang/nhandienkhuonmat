<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª®ng d·ª•ng Nh·∫≠n Di·ªán Khu√¥n M·∫∑t - Face Recognition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2a3a8c, #3a4aac);
            color: #f0f0f0;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #ff7e5f, #feb47b);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto 20px;
        }
        
        .app-description {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .app-description h2 {
            color: #feb47b;
            margin-bottom: 10px;
        }
        
        .status-container {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
        }
        
        .status {
            display: flex;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.4);
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .status i {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .status-loading {
            color: #ffcc00;
        }
        
        .status-ready {
            color: #4CAF50;
        }
        
        .status-error {
            color: #ff5252;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .video-section {
            flex: 1;
            min-width: 300px;
        }
        
        .results-section {
            flex: 1;
            min-width: 300px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #feb47b;
            border-bottom: 2px solid rgba(254, 180, 123, 0.3);
            padding-bottom: 8px;
        }
        
        .video-container {
            position: relative;
            width: 100%;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            background-color: #000;
        }
        
        #video {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 15px;
        }
        
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        button i {
            margin-right: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #ff7e5f, #feb47b);
            color: white;
        }
        
        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-success {
            background: linear-gradient(90deg, #4CAF50, #2E7D32);
            color: white;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .detection-results {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .detection-results::-webkit-scrollbar {
            width: 8px;
        }
        
        .detection-results::-webkit-scrollbar-thumb {
            background-color: rgba(254, 180, 123, 0.5);
            border-radius: 4px;
        }
        
        .face-card {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #feb47b;
        }
        
        .face-id {
            font-weight: bold;
            color: #feb47b;
            margin-bottom: 5px;
        }
        
        .face-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .face-detail {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .detail-label {
            font-weight: 600;
            color: #aaa;
        }
        
        .detail-value {
            font-weight: 600;
            color: #f0f0f0;
        }
        
        .no-faces {
            text-align: center;
            padding: 30px;
            color: #aaa;
            font-style: italic;
        }
        
        .detection-stats {
            display: flex;
            justify-content: space-around;
            background-color: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #feb47b;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 5px;
        }
        
        .options {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .options h3 {
            margin-bottom: 15px;
            color: #feb47b;
        }
        
        .option-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            border-radius: 8px;
            flex: 1;
            min-width: 200px;
        }
        
        .option-item label {
            margin-left: 10px;
            cursor: pointer;
        }
        
        .option-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .option-item input[type="range"] {
            flex: 1;
            margin: 0 10px;
            cursor: pointer;
        }
        
        .option-value {
            min-width: 40px;
            text-align: right;
            font-weight: 600;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #aaa;
            font-size: 0.9rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .feature-item {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
        }
        
        .feature-item i {
            color: #feb47b;
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
        
        .accuracy-high {
            color: #4CAF50;
        }
        
        .accuracy-medium {
            color: #ff9800;
        }
        
        .accuracy-low {
            color: #ff5252;
        }
        
        .demo-face {
            position: absolute;
            border: 2px solid #feb47b;
            border-radius: 10px;
        }
        
        .demo-face-id {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 5px;
            font-size: 12px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-robot"></i> ·ª®ng d·ª•ng Nh·∫≠n Di·ªán Khu√¥n M·∫∑t</h1>
            <p class="subtitle">S·ª≠ d·ª•ng c√¥ng ngh·ªá AI ti√™n ti·∫øn ƒë·ªÉ nh·∫≠n di·ªán khu√¥n m·∫∑t v·ªõi ƒë·ªô ch√≠nh x√°c cao</p>
        </header>
        
        <div class="app-description">
            <h2>C√¥ng ngh·ªá ti√™n ti·∫øn</h2>
            <p>·ª®ng d·ª•ng n√†y s·ª≠ d·ª•ng th∆∞ vi·ªán Face-API.js t√≠ch h·ª£p TensorFlow.js, cung c·∫•p kh·∫£ nƒÉng nh·∫≠n di·ªán khu√¥n m·∫∑t th·ªùi gian th·ª±c v·ªõi c√°c t√≠nh nƒÉng hi·ªán ƒë·∫°i nh·∫•t:</p>
            <div class="feature-list">
                <div class="feature-item"><i class="fas fa-check-circle"></i> Ph√°t hi·ªán khu√¥n m·∫∑t ƒëa ƒëi·ªÉm</div>
                <div class="feature-item"><i class="fas fa-check-circle"></i> Nh·∫≠n di·ªán ƒëi·ªÉm m·ªëc tr√™n khu√¥n m·∫∑t</div>
                <div class="feature-item"><i class="fas fa-check-circle"></i> ∆Ø·ªõc t√≠nh tu·ªïi v√† gi·ªõi t√≠nh</div>
                <div class="feature-item"><i class="fas fa-check-circle"></i> Nh·∫≠n di·ªán bi·ªÉu c·∫£m khu√¥n m·∫∑t</div>
                <div class="feature-item"><i class="fas fa-check-circle"></i> So kh·ªõp khu√¥n m·∫∑t v·ªõi ƒë·ªô ch√≠nh x√°c cao</div>
            </div>
        </div>
        
        <div class="status-container">
            <div class="status" id="status">
                <i class="fas fa-sync-alt fa-spin"></i>
                <span>ƒêang t·∫£i m√¥ h√¨nh AI...</span>
            </div>
        </div>
        
        <div class="main-content">
            <div class="video-section">
                <h2 class="section-title"><i class="fas fa-video"></i> Camera Tr·ª±c Ti·∫øp</h2>
                <div class="video-container">
                    <video id="video" width="600" height="450" autoplay muted playsinline></video>
                    <canvas id="overlay"></canvas>
                </div>
                
                <div class="controls">
                    <button id="startButton" class="btn-primary">
                        <i class="fas fa-play"></i> B·∫Øt ƒë·∫ßu nh·∫≠n di·ªán
                    </button>
                    <button id="stopButton" class="btn-secondary">
                        <i class="fas fa-stop"></i> D·ª´ng nh·∫≠n di·ªán
                    </button>
                    <button id="captureButton" class="btn-success">
                        <i class="fas fa-camera"></i> Ch·ª•p ·∫£nh
                    </button>
                    <button id="demoButton" class="btn-secondary">
                        <i class="fas fa-eye"></i> Ch·∫ø ƒë·ªô Demo
                    </button>
                </div>
                
                <div class="detection-stats">
                    <div class="stat">
                        <div class="stat-value" id="faceCount">0</div>
                        <div class="stat-label">Khu√¥n m·∫∑t</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="detectionTime">0ms</div>
                        <div class="stat-label">Th·ªùi gian x·ª≠ l√Ω</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="fpsCounter">0</div>
                        <div class="stat-label">FPS</div>
                    </div>
                </div>
            </div>
            
            <div class="results-section">
                <h2 class="section-title"><i class="fas fa-chart-bar"></i> K·∫øt qu·∫£ nh·∫≠n di·ªán</h2>
                <div class="detection-results" id="resultsContainer">
                    <div class="no-faces">
                        <i class="fas fa-user-slash fa-3x"></i>
                        <p>Ch∆∞a ph√°t hi·ªán khu√¥n m·∫∑t n√†o</p>
                        <p>H√£y b·∫≠t camera v√† b·∫Øt ƒë·∫ßu nh·∫≠n di·ªán</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="options">
            <h3><i class="fas fa-cogs"></i> T√πy ch·ªçn nh·∫≠n di·ªán</h3>
            <div class="option-group">
                <div class="option-item">
                    <input type="checkbox" id="showLandmarks" checked>
                    <label for="showLandmarks">Hi·ªÉn th·ªã ƒëi·ªÉm m·ªëc khu√¥n m·∫∑t</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="showBoxes" checked>
                    <label for="showBoxes">Hi·ªÉn th·ªã khung khu√¥n m·∫∑t</label>
                </div>
                <div class="option-item">
                    <input type="checkbox" id="showExpressions" checked>
                    <label for="showExpressions">Hi·ªÉn th·ªã bi·ªÉu c·∫£m</label>
                </div>
            </div>
            <div class="option-group">
                <div class="option-item">
                    <label for="detectionInterval">T·∫ßn su·∫•t nh·∫≠n di·ªán:</label>
                    <input type="range" id="detectionInterval" min="50" max="500" value="100" step="50">
                    <span class="option-value" id="intervalValue">100ms</span>
                </div>
                <div class="option-item">
                    <label for="minConfidence">ƒê·ªô tin c·∫≠y t·ªëi thi·ªÉu:</label>
                    <input type="range" id="minConfidence" min="0.1" max="1.0" value="0.5" step="0.1">
                    <span class="option-value" id="confidenceValue">0.5</span>
                </div>
            </div>
        </div>
        
        <footer>
            <p>·ª®ng d·ª•ng Nh·∫≠n Di·ªán Khu√¥n M·∫∑t &copy; 2023 | S·ª≠ d·ª•ng Face-API.js & TensorFlow.js</p>
            <p>L∆∞u √Ω: ·ª®ng d·ª•ng ho·∫°t ƒë·ªông ho√†n to√†n tr√™n tr√¨nh duy·ªát, kh√¥ng l∆∞u tr·ªØ d·ªØ li·ªáu h√¨nh ·∫£nh</p>
            <p style="margin-top: 10px; font-size: 0.8rem; color: #888;">
                <i class="fas fa-info-circle"></i> 
                ·ª®ng d·ª•ng c√≥ ch·∫ø ƒë·ªô demo t·ª± ƒë·ªông n·∫øu camera kh√¥ng kh·∫£ d·ª•ng
            </p>
        </footer>
    </div>

    <script>
        // Khai b√°o c√°c bi·∫øn to√†n c·ª•c
        let video = document.getElementById('video');
        let overlay = document.getElementById('overlay');
        let overlayCtx = overlay.getContext('2d');
        let isDetecting = false;
        let detectionInterval = 100; // ms
        let lastDetectionTime = 0;
        let frameCount = 0;
        let fps = 0;
        let lastFpsUpdate = Date.now();
        let modelsLoaded = false;
        let isDemoMode = false;
        let demoInterval = null;
        
        // C√°c tham s·ªë nh·∫≠n di·ªán
        let detectionOptions = {
            showLandmarks: true,
            showBoxes: true,
            showExpressions: true,
            minConfidence: 0.5
        };
        
        // D·ªØ li·ªáu demo (khu√¥n m·∫∑t ·∫£o cho ch·∫ø ƒë·ªô demo)
        const demoFaces = [
            { id: 1, x: 150, y: 100, width: 120, height: 150, age: 28, gender: 'male', expression: 'happy', confidence: 0.92 },
            { id: 2, x: 350, y: 120, width: 110, height: 140, age: 35, gender: 'female', expression: 'neutral', confidence: 0.88 },
            { id: 3, x: 500, y: 90, width: 100, height: 130, age: 22, gender: 'male', expression: 'surprised', confidence: 0.85 }
        ];
        
        // C√°c ph·∫ßn t·ª≠ DOM
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const captureButton = document.getElementById('captureButton');
        const demoButton = document.getElementById('demoButton');
        const statusElement = document.getElementById('status');
        const faceCountElement = document.getElementById('faceCount');
        const detectionTimeElement = document.getElementById('detectionTime');
        const fpsCounterElement = document.getElementById('fpsCounter');
        const resultsContainer = document.getElementById('resultsContainer');
        const showLandmarksCheckbox = document.getElementById('showLandmarks');
        const showBoxesCheckbox = document.getElementById('showBoxes');
        const showExpressionsCheckbox = document.getElementById('showExpressions');
        const detectionIntervalSlider = document.getElementById('detectionInterval');
        const intervalValueElement = document.getElementById('intervalValue');
        const minConfidenceSlider = document.getElementById('minConfidence');
        const confidenceValueElement = document.getElementById('confidenceValue');
        
        // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i
        function updateStatus(message, type = 'loading') {
            const icon = statusElement.querySelector('i');
            const text = statusElement.querySelector('span');
            
            text.textContent = message;
            
            // C·∫≠p nh·∫≠t l·ªõp CSS d·ª±a tr√™n lo·∫°i tr·∫°ng th√°i
            statusElement.className = 'status';
            if (type === 'loading') {
                statusElement.classList.add('status-loading');
                icon.className = 'fas fa-sync-alt fa-spin';
            } else if (type === 'ready') {
                statusElement.classList.add('status-ready');
                icon.className = 'fas fa-check-circle';
            } else if (type === 'error') {
                statusElement.classList.add('status-error');
                icon.className = 'fas fa-exclamation-circle';
            } else if (type === 'demo') {
                statusElement.classList.add('status-ready');
                icon.className = 'fas fa-eye';
            }
        }
        
        // H√†m t·∫£i m√¥ h√¨nh AI - S·ª≠ d·ª•ng CDN thay v√¨ /models
        async function loadModels() {
            try {
                updateStatus('ƒêang t·∫£i m√¥ h√¨nh nh·∫≠n di·ªán khu√¥n m·∫∑t...', 'loading');
                
                // S·ª≠ d·ª•ng CDN cho c√°c m√¥ h√¨nh (fix l·ªói 404 tr√™n GitHub)
                // L∆∞u √Ω: ƒê√¢y l√† weights c·ªßa face-api.js t·ª´ jsdelivr
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights/';
                
                // T·∫£i c√°c m√¥ h√¨nh c·∫ßn thi·∫øt t·ª´ CDN
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
                await faceapi.nets.ageGenderNet.loadFromUri(MODEL_URL);
                
                updateStatus('M√¥ h√¨nh AI ƒë√£ s·∫µn s√†ng!', 'ready');
                modelsLoaded = true;
                
                // K√≠ch ho·∫°t n√∫t b·∫Øt ƒë·∫ßu
                startButton.disabled = false;
                demoButton.disabled = false;
                
                console.log('T·∫•t c·∫£ m√¥ h√¨nh ƒë√£ ƒë∆∞·ª£c t·∫£i th√†nh c√¥ng t·ª´ CDN');
            } catch (error) {
                console.error('L·ªói khi t·∫£i m√¥ h√¨nh:', error);
                updateStatus('L·ªói khi t·∫£i m√¥ h√¨nh. K√≠ch ho·∫°t ch·∫ø ƒë·ªô demo...', 'error');
                
                // N·∫øu kh√¥ng t·∫£i ƒë∆∞·ª£c m√¥ h√¨nh, k√≠ch ho·∫°t ch·∫ø ƒë·ªô demo
                modelsLoaded = false;
                startButton.disabled = true;
                demoButton.disabled = false;
                setTimeout(() => {
                    enableDemoMode();
                }, 2000);
            }
        }
        
        // H√†m kh·ªüi ƒë·ªông camera
        async function startCamera() {
            try {
                updateStatus('ƒêang k·∫øt n·ªëi v·ªõi camera...', 'loading');
                
                // Ki·ªÉm tra xem tr√¨nh duy·ªát c√≥ h·ªó tr·ª£ getUserMedia kh√¥ng
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ truy c·∫≠p camera');
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: false
                });
                
                video.srcObject = stream;
                
                // Ch·ªù cho video s·∫µn s√†ng
                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        resolve();
                    };
                    video.onerror = () => {
                        reject(new Error('L·ªói khi t·∫£i video'));
                    };
                    
                    // Timeout sau 5 gi√¢y
                    setTimeout(() => {
                        reject(new Error('Timeout khi t·∫£i video'));
                    }, 5000);
                });
                
                // ƒê·∫∑t k√≠ch th∆∞·ªõc overlay b·∫±ng v·ªõi video
                overlay.width = video.videoWidth || 600;
                overlay.height = video.videoHeight || 450;
                
                updateStatus('Camera ƒë√£ s·∫µn s√†ng!', 'ready');
                return true;
            } catch (error) {
                console.error('L·ªói khi truy c·∫≠p camera:', error);
                updateStatus('Kh√¥ng th·ªÉ truy c·∫≠p camera. K√≠ch ho·∫°t ch·∫ø ƒë·ªô demo...', 'error');
                
                // T·∫°o video gi·∫£ ƒë·ªÉ demo
                createDemoVideo();
                return false;
            }
        }
        
        // T·∫°o video demo n·∫øu kh√¥ng c√≥ camera
        function createDemoVideo() {
            // ƒê·∫∑t k√≠ch th∆∞·ªõc cho overlay
            overlay.width = 600;
            overlay.height = 450;
            
            // V·∫Ω n·ªÅn cho video demo
            overlayCtx.fillStyle = '#222';
            overlayCtx.fillRect(0, 0, overlay.width, overlay.height);
            
            // V·∫Ω ti√™u ƒë·ªÅ demo
            overlayCtx.fillStyle = '#fff';
            overlayCtx.font = '24px Arial';
            overlayCtx.textAlign = 'center';
            overlayCtx.fillText('CH·∫æ ƒê·ªò DEMO', overlay.width/2, 50);
            
            // V·∫Ω h√¨nh ·∫£nh m·∫∑t c∆∞·ªùi
            overlayCtx.font = '120px Arial';
            overlayCtx.fillText('üòä', overlay.width/2, overlay.height/2);
            
            overlayCtx.font = '18px Arial';
            overlayCtx.fillText('Camera kh√¥ng kh·∫£ d·ª•ng. ƒêang s·ª≠ d·ª•ng ch·∫ø ƒë·ªô demo.', overlay.width/2, overlay.height - 50);
            
            updateStatus('ƒêang ch·∫°y ch·∫ø ƒë·ªô demo', 'demo');
            
            // K√≠ch ho·∫°t ch·∫ø ƒë·ªô demo
            enableDemoMode();
        }
        
        // K√≠ch ho·∫°t ch·∫ø ƒë·ªô demo
        function enableDemoMode() {
            isDemoMode = true;
            modelsLoaded = true; // Cho ph√©p nh·∫≠n di·ªán trong ch·∫ø ƒë·ªô demo
            startButton.disabled = false;
            stopButton.disabled = false;
            captureButton.disabled = false;
            
            console.log('ƒê√£ k√≠ch ho·∫°t ch·∫ø ƒë·ªô demo');
        }
        
        // Ch·∫°y ch·∫ø ƒë·ªô demo (t·∫°o khu√¥n m·∫∑t ·∫£o)
        function runDemoDetection() {
            if (!isDemoMode || !isDetecting) return;
            
            const startTime = performance.now();
            
            // X√≥a canvas tr∆∞·ªõc khi v·∫Ω
            overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
            
            // V·∫Ω n·ªÅn
            overlayCtx.fillStyle = '#222';
            overlayCtx.fillRect(0, 0, overlay.width, overlay.height);
            
            // V·∫Ω c√°c khu√¥n m·∫∑t demo
            demoFaces.forEach(face => {
                // V·∫Ω khung khu√¥n m·∫∑t
                if (detectionOptions.showBoxes) {
                    overlayCtx.strokeStyle = '#feb47b';
                    overlayCtx.lineWidth = 2;
                    overlayCtx.strokeRect(face.x, face.y, face.width, face.height);
                    
                    // V·∫Ω nh√£n ƒë·ªô ch√≠nh x√°c
                    overlayCtx.fillStyle = 'rgba(254, 180, 123, 0.8)';
                    overlayCtx.fillRect(face.x, face.y - 25, 80, 25);
                    overlayCtx.fillStyle = '#000';
                    overlayCtx.font = '14px Arial';
                    overlayCtx.fillText(`${(face.confidence * 100).toFixed(1)}%`, face.x + 5, face.y - 8);
                }
                
                // V·∫Ω ƒëi·ªÉm m·ªëc (ƒë∆°n gi·∫£n h√≥a)
                if (detectionOptions.showLandmarks) {
                    overlayCtx.fillStyle = '#4CAF50';
                    // V·∫Ω c√°c ƒëi·ªÉm m·ªëc ƒë∆°n gi·∫£n
                    for (let i = 0; i < 5; i++) {
                        const landmarkX = face.x + face.width/2 + (i-2) * 15;
                        const landmarkY = face.y + face.height/2;
                        overlayCtx.beginPath();
                        overlayCtx.arc(landmarkX, landmarkY, 3, 0, Math.PI * 2);
                        overlayCtx.fill();
                    }
                }
                
                // V·∫Ω th√¥ng tin bi·ªÉu c·∫£m, tu·ªïi, gi·ªõi t√≠nh
                if (detectionOptions.showExpressions) {
                    const genderText = face.gender === 'male' ? 'Nam' : 'N·ªØ';
                    const expressionTranslations = {
                        'happy': 'Vui v·∫ª',
                        'neutral': 'Trung t√≠nh',
                        'surprised': 'Ng·∫°c nhi√™n',
                        'sad': 'Bu·ªìn b√£',
                        'angry': 'T·ª©c gi·∫≠n',
                        'fearful': 'S·ª£ h√£i',
                        'disgusted': 'Kh√≥ ch·ªãu'
                    };
                    const expressionText = expressionTranslations[face.expression] || face.expression;
                    
                    overlayCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    overlayCtx.fillRect(face.x, face.y + face.height, 150, 60);
                    overlayCtx.fillStyle = '#fff';
                    overlayCtx.font = '12px Arial';
                    overlayCtx.fillText(`${genderText}, ${face.age} tu·ªïi`, face.x + 5, face.y + face.height + 15);
                    overlayCtx.fillText(`Bi·ªÉu c·∫£m: ${expressionText}`, face.x + 5, face.y + face.height + 35);
                }
            });
            
            const detectionTime = performance.now() - startTime;
            
            // C·∫≠p nh·∫≠t th·ªëng k√™
            updateStats(demoFaces.length, detectionTime);
            
            // C·∫≠p nh·∫≠t k·∫øt qu·∫£ chi ti·∫øt
            updateDemoResults();
            
            // ƒê·∫øm FPS
            updateFps();
            
            // L·∫∑p l·∫°i sau kho·∫£ng th·ªùi gian ƒë√£ ƒë·∫∑t
            demoInterval = setTimeout(() => {
                if (isDetecting && isDemoMode) {
                    runDemoDetection();
                }
            }, detectionInterval);
        }
        
        // H√†m b·∫Øt ƒë·∫ßu nh·∫≠n di·ªán
        function startDetection() {
            if (!modelsLoaded) {
                alert('M√¥ h√¨nh AI ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng ƒë·ª£i...');
                return;
            }
            
            isDetecting = true;
            startButton.disabled = true;
            stopButton.disabled = false;
            captureButton.disabled = false;
            demoButton.disabled = true;
            
            if (isDemoMode) {
                updateStatus('ƒêang nh·∫≠n di·ªán (ch·∫ø ƒë·ªô DEMO)...', 'demo');
                runDemoDetection();
            } else {
                updateStatus('ƒêang nh·∫≠n di·ªán khu√¥n m·∫∑t...', 'loading');
                // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p nh·∫≠n di·ªán th·∫≠t
                detectFaces();
            }
        }
        
        // H√†m d·ª´ng nh·∫≠n di·ªán
        function stopDetection() {
            isDetecting = false;
            startButton.disabled = false;
            stopButton.disabled = true;
            captureButton.disabled = true;
            demoButton.disabled = false;
            
            if (demoInterval) {
                clearTimeout(demoInterval);
                demoInterval = null;
            }
            
            // X√≥a canvas
            overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
            
            if (isDemoMode) {
                updateStatus('ƒê√£ d·ª´ng nh·∫≠n di·ªán (DEMO)', 'demo');
            } else {
                updateStatus('ƒê√£ d·ª´ng nh·∫≠n di·ªán', 'ready');
            }
            
            // X√≥a k·∫øt qu·∫£
            resultsContainer.innerHTML = `
                <div class="no-faces">
                    <i class="fas fa-user-slash fa-3x"></i>
                    <p>Ch∆∞a ph√°t hi·ªán khu√¥n m·∫∑t n√†o</p>
                    <p>H√£y b·∫≠t camera v√† b·∫Øt ƒë·∫ßu nh·∫≠n di·ªán</p>
                </div>
            `;
            
            // Reset th·ªëng k√™
            faceCountElement.textContent = '0';
            detectionTimeElement.textContent = '0ms';
        }
        
        // H√†m nh·∫≠n di·ªán khu√¥n m·∫∑t th·∫≠t
        async function detectFaces() {
            if (!isDetecting || isDemoMode) return;
            
            const startTime = performance.now();
            
            try {
                // X√≥a canvas tr∆∞·ªõc khi v·∫Ω
                overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
                
                // Ph√°t hi·ªán khu√¥n m·∫∑t
                const detections = await faceapi.detectAllFaces(
                    video, 
                    new faceapi.TinyFaceDetectorOptions({ 
                        inputSize: 320, 
                        scoreThreshold: detectionOptions.minConfidence 
                    })
                )
                .withFaceLandmarks()
                .withFaceExpressions()
                .withAgeAndGender();
                
                const detectionTime = performance.now() - startTime;
                
                // V·∫Ω k·∫øt qu·∫£ l√™n canvas
                if (detectionOptions.showBoxes) {
                    faceapi.draw.drawDetections(overlay, detections);
                }
                
                if (detectionOptions.showLandmarks) {
                    faceapi.draw.drawFaceLandmarks(overlay, detections);
                }
                
                if (detectionOptions.showExpressions) {
                    faceapi.draw.drawFaceExpressions(overlay, detections);
                }
                
                // V·∫Ω th√¥ng tin tu·ªïi v√† gi·ªõi t√≠nh
                detections.forEach(detection => {
                    if (detection.age && detection.gender) {
                        const age = Math.round(detection.age);
                        const gender = detection.gender;
                        const genderText = gender === 'male' ? 'Nam' : 'N·ªØ';
                        
                        const box = detection.detection.box;
                        const text = `${genderText}, ${age} tu·ªïi`;
                        const textWidth = overlayCtx.measureText(text).width;
                        
                        overlayCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                        overlayCtx.fillRect(
                            box.x, 
                            box.y - 25, 
                            textWidth + 10, 
                            25
                        );
                        
                        overlayCtx.font = '16px Arial';
                        overlayCtx.fillStyle = '#fff';
                        overlayCtx.fillText(text, box.x + 5, box.y - 8);
                    }
                });
                
                // C·∫≠p nh·∫≠t th·ªëng k√™
                updateStats(detections.length, detectionTime);
                
                // C·∫≠p nh·∫≠t k·∫øt qu·∫£ chi ti·∫øt
                updateResults(detections);
                
                // ƒê·∫øm FPS
                updateFps();
                
            } catch (error) {
                console.error('L·ªói trong qu√° tr√¨nh nh·∫≠n di·ªán:', error);
            }
            
            // L·∫∑p l·∫°i sau kho·∫£ng th·ªùi gian ƒë√£ ƒë·∫∑t
            setTimeout(() => {
                if (isDetecting && !isDemoMode) {
                    requestAnimationFrame(detectFaces);
                }
            }, detectionInterval);
        }
        
        // H√†m c·∫≠p nh·∫≠t th·ªëng k√™
        function updateStats(faceCount, detectionTime) {
            faceCountElement.textContent = faceCount;
            detectionTimeElement.textContent = `${detectionTime.toFixed(1)}ms`;
        }
        
        // H√†m c·∫≠p nh·∫≠t FPS
        function updateFps() {
            frameCount++;
            const now = Date.now();
            const elapsed = now - lastFpsUpdate;
            
            if (elapsed >= 1000) { // C·∫≠p nh·∫≠t FPS m·ªói gi√¢y
                fps = Math.round((frameCount * 1000) / elapsed);
                fpsCounterElement.textContent = fps;
                frameCount = 0;
                lastFpsUpdate = now;
            }
        }
        
        // H√†m c·∫≠p nh·∫≠t k·∫øt qu·∫£ chi ti·∫øt (cho nh·∫≠n di·ªán th·∫≠t)
        function updateResults(detections) {
            if (detections.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="no-faces">
                        <i class="fas fa-user-slash fa-3x"></i>
                        <p>Kh√¥ng ph√°t hi·ªán khu√¥n m·∫∑t n√†o</p>
                    </div>
                `;
                return;
            }
            
            let resultsHTML = '';
            
            detections.forEach((detection, index) => {
                // X√°c ƒë·ªãnh ƒë·ªô ch√≠nh x√°c
                const score = detection.detection.score;
                let accuracyClass = 'accuracy-low';
                if (score >= 0.8) accuracyClass = 'accuracy-high';
                else if (score >= 0.6) accuracyClass = 'accuracy-medium';
                
                // X√°c ƒë·ªãnh bi·ªÉu c·∫£m ch√≠nh
                const expressions = detection.expressions;
                let dominantExpression = 'Trung t√≠nh';
                let maxExpressionScore = 0;
                
                if (expressions) {
                    for (const [expression, score] of Object.entries(expressions)) {
                        if (score > maxExpressionScore) {
                            maxExpressionScore = score;
                            dominantExpression = expression;
                        }
                    }
                }
                
                // D·ªãch bi·ªÉu c·∫£m sang ti·∫øng Vi·ªát
                const expressionTranslations = {
                    'neutral': 'Trung t√≠nh',
                    'happy': 'Vui v·∫ª',
                    'sad': 'Bu·ªìn b√£',
                    'angry': 'T·ª©c gi·∫≠n',
                    'fearful': 'S·ª£ h√£i',
                    'disgusted': 'Kh√≥ ch·ªãu',
                    'surprised': 'Ng·∫°c nhi√™n'
                };
                
                const translatedExpression = expressionTranslations[dominantExpression] || dominantExpression;
                
                // X√°c ƒë·ªãnh gi·ªõi t√≠nh v√† tu·ªïi
                const age = detection.age ? Math.round(detection.age) : 'Kh√¥ng x√°c ƒë·ªãnh';
                const gender = detection.gender || 'Kh√¥ng x√°c ƒë·ªãnh';
                const genderText = gender === 'male' ? 'Nam' : (gender === 'female' ? 'N·ªØ' : 'Kh√¥ng x√°c ƒë·ªãnh');
                
                resultsHTML += `
                    <div class="face-card">
                        <div class="face-id">Khu√¥n m·∫∑t #${index + 1}</div>
                        <div class="face-details">
                            <div class="face-detail">
                                <span class="detail-label">ƒê·ªô ch√≠nh x√°c:</span>
                                <span class="detail-value ${accuracyClass}">${(score * 100).toFixed(1)}%</span>
                            </div>
                            <div class="face-detail">
                                <span class="detail-label">Bi·ªÉu c·∫£m:</span>
                                <span class="detail-value">${translatedExpression}</span>
                            </div>
                            <div class="face-detail">
                                <span class="detail-label">Gi·ªõi t√≠nh:</span>
                                <span class="detail-value">${genderText}</span>
                            </div>
                            <div class="face-detail">
                                <span class="detail-label">Tu·ªïi ∆∞·ªõc t√≠nh:</span>
                                <span class="detail-value">${age}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = resultsHTML;
        }
        
        // H√†m c·∫≠p nh·∫≠t k·∫øt qu·∫£ demo
        function updateDemoResults() {
            let resultsHTML = '';
            
            demoFaces.forEach((face, index) => {
                let accuracyClass = 'accuracy-low';
                if (face.confidence >= 0.8) accuracyClass = 'accuracy-high';
                else if (face.confidence >= 0.6) accuracyClass = 'accuracy-medium';
                
                const genderText = face.gender === 'male' ? 'Nam' : 'N·ªØ';
                const expressionTranslations = {
                    'happy': 'Vui v·∫ª',
                    'neutral': 'Trung t√≠nh',
                    'surprised': 'Ng·∫°c nhi√™n',
                    'sad': 'Bu·ªìn b√£',
                    'angry': 'T·ª©c gi·∫≠n',
                    'fearful': 'S·ª£ h√£i',
                    'disgusted': 'Kh√≥ ch·ªãu'
                };
                const translatedExpression = expressionTranslations[face.expression] || face.expression;
                
                resultsHTML += `
                    <div class="face-card">
                        <div class="face-id">Khu√¥n m·∫∑t Demo #${index + 1}</div>
                        <div class="face-details">
                            <div class="face-detail">
                                <span class="detail-label">ƒê·ªô ch√≠nh x√°c:</span>
                                <span class="detail-value ${accuracyClass}">${(face.confidence * 100).toFixed(1)}%</span>
                            </div>
                            <div class="face-detail">
                                <span class="detail-label">Bi·ªÉu c·∫£m:</span>
                                <span class="detail-value">${translatedExpression}</span>
                            </div>
                            <div class="face-detail">
                                <span class="detail-label">Gi·ªõi t√≠nh:</span>
                                <span class="detail-value">${genderText}</span>
                            </div>
                            <div class="face-detail">
                                <span class="detail-label">Tu·ªïi ∆∞·ªõc t√≠nh:</span>
                                <span class="detail-value">${face.age}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = resultsHTML;
        }
        
        // H√†m ch·ª•p ·∫£nh
        function captureImage() {
            if (!isDetecting) {
                alert('Vui l√≤ng b·∫≠t ch·∫ø ƒë·ªô nh·∫≠n di·ªán tr∆∞·ªõc khi ch·ª•p ·∫£nh');
                return;
            }
            
            // T·∫°o canvas t·∫°m th·ªùi
            const tempCanvas = document.createElement('canvas');
            
            if (isDemoMode) {
                tempCanvas.width = overlay.width;
                tempCanvas.height = overlay.height;
                const tempCtx = tempCanvas.getContext('2d');
                
                // V·∫Ω n·ªÅn demo
                tempCtx.fillStyle = '#222';
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                // V·∫Ω ti√™u ƒë·ªÅ
                tempCtx.fillStyle = '#fff';
                tempCtx.font = '24px Arial';
                tempCtx.textAlign = 'center';
                tempCtx.fillText('CH·∫æ ƒê·ªò DEMO - K·∫æT QU·∫¢ NH·∫¨N DI·ªÜN', tempCanvas.width/2, 40);
                
                // V·∫Ω overlay
                tempCtx.drawImage(overlay, 0, 0);
            } else {
                tempCanvas.width = video.videoWidth || overlay.width;
                tempCanvas.height = video.videoHeight || overlay.height;
                const tempCtx = tempCanvas.getContext('2d');
                
                // V·∫Ω video v√† overlay l√™n canvas
                tempCtx.drawImage(video, 0, 0, tempCanvas.width, tempCanvas.height);
                tempCtx.drawImage(overlay, 0, 0);
            }
            
            // T·∫°o li√™n k·∫øt t·∫£i v·ªÅ
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            link.download = `face-detection-${timestamp}.png`;
            link.href = tempCanvas.toDataURL('image/png');
            link.click();
            
            // Th√¥ng b√°o
            alert('ƒê√£ l∆∞u ·∫£nh th√†nh c√¥ng!');
        }
        
        // H√†m chuy·ªÉn sang ch·∫ø ƒë·ªô demo
        function switchToDemoMode() {
            if (isDetecting) {
                stopDetection();
            }
            
            // T·∫Øt video stream n·∫øu c√≥
            if (video.srcObject) {
                const tracks = video.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }
            
            // K√≠ch ho·∫°t ch·∫ø ƒë·ªô demo
            isDemoMode = true;
            createDemoVideo();
            startButton.disabled = false;
            stopButton.disabled = true;
            captureButton.disabled = true;
            
            updateStatus('Ch·∫ø ƒë·ªô demo ƒë√£ s·∫µn s√†ng', 'demo');
        }
        
        // H√†m kh·ªüi t·∫°o ·ª©ng d·ª•ng
        async function initApp() {
            console.log('ƒêang kh·ªüi t·∫°o ·ª©ng d·ª•ng nh·∫≠n di·ªán khu√¥n m·∫∑t...');
            
            // V√¥ hi·ªáu h√≥a c√°c n√∫t cho ƒë·∫øn khi s·∫µn s√†ng
            startButton.disabled = true;
            stopButton.disabled = true;
            captureButton.disabled = true;
            demoButton.disabled = true;
            
            // Thi·∫øt l·∫≠p s·ª± ki·ªán cho c√°c n√∫t
            startButton.addEventListener('click', startDetection);
            stopButton.addEventListener('click', stopDetection);
            captureButton.addEventListener('click', captureImage);
            demoButton.addEventListener('click', switchToDemoMode);
            
            // Thi·∫øt l·∫≠p s·ª± ki·ªán cho c√°c t√πy ch·ªçn
            showLandmarksCheckbox.addEventListener('change', (e) => {
                detectionOptions.showLandmarks = e.target.checked;
            });
            
            showBoxesCheckbox.addEventListener('change', (e) => {
                detectionOptions.showBoxes = e.target.checked;
            });
            
            showExpressionsCheckbox.addEventListener('change', (e) => {
                detectionOptions.showExpressions = e.target.checked;
            });
            
            detectionIntervalSlider.addEventListener('input', (e) => {
                detectionInterval = parseInt(e.target.value);
                intervalValueElement.textContent = `${detectionInterval}ms`;
            });
            
            minConfidenceSlider.addEventListener('input', (e) => {
                detectionOptions.minConfidence = parseFloat(e.target.value);
                confidenceValueElement.textContent = detectionOptions.minConfidence;
            });
            
            // T·∫£i m√¥ h√¨nh AI v√† kh·ªüi ƒë·ªông camera
            await loadModels();
            await startCamera();
            
            console.log('·ª®ng d·ª•ng ƒë√£ s·∫µn s√†ng!');
        }
        
        // Kh·ªüi ch·∫°y ·ª©ng d·ª•ng khi trang ƒë√£ t·∫£i xong
        document.addEventListener('DOMContentLoaded', initApp);
        
        // X·ª≠ l√Ω khi ng∆∞·ªùi d√πng r·ªùi trang
        window.addEventListener('beforeunload', () => {
            if (isDetecting) {
                stopDetection();
            }
            
            // D·ª´ng t·∫•t c·∫£ c√°c track camera
            if (video.srcObject) {
                const tracks = video.srcObject.getTracks();
                tracks.forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
