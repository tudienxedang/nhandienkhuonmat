<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Nhận Diện Khuôn Mặt - Face Recognition (Final Fix)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    
    <style>
        /* CSS GIỮ NGUYÊN NHƯ CŨ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #1a2a6c, #2a3a8c, #3a4aac); color: #f0f0f0; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; padding: 20px 0; margin-bottom: 30px; }
        h1 { font-size: 2.5rem; margin-bottom: 10px; background: linear-gradient(90deg, #ff7e5f, #feb47b); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .subtitle { font-size: 1.2rem; opacity: 0.9; max-width: 600px; margin: 0 auto 20px; }
        .app-description { background-color: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 10px; margin-bottom: 30px; line-height: 1.6; }
        .status-container { display: flex; justify-content: center; margin-bottom: 25px; }
        .status { display: flex; align-items: center; background-color: rgba(0, 0, 0, 0.4); padding: 12px 25px; border-radius: 50px; font-weight: 600; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        .status i { margin-right: 10px; font-size: 1.2rem; }
        .status-loading { color: #ffcc00; }
        .status-ready { color: #4CAF50; }
        .status-error { color: #ff5252; }
        .main-content { display: flex; flex-wrap: wrap; gap: 30px; margin-bottom: 30px; }
        .video-section { flex: 1; min-width: 300px; }
        .results-section { flex: 1; min-width: 300px; background-color: rgba(0, 0, 0, 0.3); border-radius: 15px; padding: 20px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); }
        .section-title { font-size: 1.5rem; margin-bottom: 20px; color: #feb47b; border-bottom: 2px solid rgba(254, 180, 123, 0.3); padding-bottom: 8px; }
        .video-container { position: relative; width: 100%; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4); background-color: #000; }
        #video { width: 100%; height: auto; display: block; border-radius: 15px; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .controls { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top: 20px; }
        button { padding: 12px 25px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; font-size: 1rem; }
        button i { margin-right: 8px; }
        .btn-primary { background: linear-gradient(90deg, #ff7e5f, #feb47b); color: white; }
        .btn-secondary { background-color: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); }
        .btn-success { background: linear-gradient(90deg, #4CAF50, #2E7D32); color: white; }
        .btn-warning { background: linear-gradient(90deg, #ff9800, #ff5722); color: white; }
        button:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .detection-results { max-height: 400px; overflow-y: auto; padding-right: 10px; }
        .detection-results::-webkit-scrollbar { width: 8px; }
        .detection-results::-webkit-scrollbar-thumb { background-color: rgba(254, 180, 123, 0.5); border-radius: 4px; }
        .face-card { background-color: rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #feb47b; }
        .face-id { font-weight: bold; color: #feb47b; margin-bottom: 5px; }
        .face-details { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 10px; }
        .face-detail { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .detail-label { font-weight: 600; color: #aaa; }
        .detail-value { font-weight: 600; color: #f0f0f0; }
        .no-faces { text-align: center; padding: 30px; color: #aaa; font-style: italic; }
        .detection-stats { display: flex; justify-content: space-around; background-color: rgba(0, 0, 0, 0.4); padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .stat { text-align: center; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #feb47b; }
        .stat-label { font-size: 0.9rem; color: #aaa; margin-top: 5px; }
        .options { background-color: rgba(0, 0, 0, 0.3); padding: 20px; border-radius: 15px; margin-top: 20px; }
        .options h3 { margin-bottom: 15px; color: #feb47b; }
        .option-group { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
        .option-item { display: flex; align-items: center; background-color: rgba(255, 255, 255, 0.05); padding: 10px 15px; border-radius: 8px; flex: 1; min-width: 200px; }
        .option-item label { margin-left: 10px; cursor: pointer; }
        .feature-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 10px; }
        .feature-item { background-color: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px; display: flex; align-items: center; }
        .feature-item i { color: #feb47b; margin-right: 10px; font-size: 1.2rem; }
        .warning-banner { background-color: rgba(255, 193, 7, 0.2); border-left: 4px solid #ffc107; padding: 10px 15px; margin-bottom: 20px; border-radius: 5px; }
        .accuracy-high { color: #4CAF50; }
        .accuracy-medium { color: #ff9800; }
        .accuracy-low { color: #ff5252; }
        @media (max-width: 768px) { .main-content { flex-direction: column; } h1 { font-size: 2rem; } .controls { flex-direction: column; } button { width: 100%; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="warning-banner">
            <i class="fas fa-check-circle"></i>
            <strong>Đã sửa lỗi xung đột thư viện:</strong> Ứng dụng đã sẵn sàng hoạt động ổn định.
        </div>
        
        <header>
            <h1><i class="fas fa-robot"></i> Ứng dụng Nhận Diện Khuôn Mặt</h1>
            <p class="subtitle">Sử dụng công nghệ AI tiên tiến để nhận diện khuôn mặt với độ chính xác cao</p>
        </header>
        
        <div class="app-description">
            <h2>Công nghệ tiên tiến</h2>
            <div class="feature-list">
                <div class="feature-item"><i class="fas fa-check-circle"></i> Phát hiện khuôn mặt đa điểm</div>
                <div class="feature-item"><i class="fas fa-check-circle"></i> Nhận diện điểm mốc (Landmarks)</div>
                <div class="feature-item"><i class="fas fa-check-circle"></i> Ước tính tuổi và giới tính</div>
                <div class="feature-item"><i class="fas fa-check-circle"></i> Nhận diện biểu cảm</div>
            </div>
        </div>
        
        <div class="status-container">
            <div class="status" id="status">
                <i class="fas fa-sync-alt fa-spin"></i>
                <span>Đang khởi tạo ứng dụng...</span>
            </div>
        </div>
        
        <div class="main-content">
            <div class="video-section">
                <h2 class="section-title"><i class="fas fa-video"></i> Camera Trực Tiếp</h2>
                <div class="video-container">
                    <video id="video" width="600" height="450" autoplay muted playsinline></video>
                    <canvas id="overlay"></canvas>
                </div>
                
                <div class="controls">
                    <button id="startButton" class="btn-primary">
                        <i class="fas fa-play"></i> Bắt đầu
                    </button>
                    <button id="stopButton" class="btn-secondary">
                        <i class="fas fa-stop"></i> Dừng
                    </button>
                    <button id="captureButton" class="btn-success">
                        <i class="fas fa-camera"></i> Chụp ảnh
                    </button>
                </div>
                
                <div class="detection-stats">
                    <div class="stat">
                        <div class="stat-value" id="faceCount">0</div>
                        <div class="stat-label">Khuôn mặt</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="fpsCounter">0</div>
                        <div class="stat-label">FPS</div>
                    </div>
                </div>
            </div>
            
            <div class="results-section">
                <h2 class="section-title"><i class="fas fa-chart-bar"></i> Kết quả nhận diện</h2>
                <div class="detection-results" id="resultsContainer">
                    <div class="no-faces">
                        <i class="fas fa-user-slash fa-3x"></i>
                        <p>Chưa phát hiện khuôn mặt nào</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="options">
            <h3><i class="fas fa-cogs"></i> Tùy chọn</h3>
            <div class="option-group">
                <div class="option-item"><input type="checkbox" id="showLandmarks" checked><label for="showLandmarks">Điểm mốc</label></div>
                <div class="option-item"><input type="checkbox" id="showBoxes" checked><label for="showBoxes">Khung mặt</label></div>
                <div class="option-item"><input type="checkbox" id="showExpressions" checked><label for="showExpressions">Biểu cảm</label></div>
            </div>
        </div>
        
        <footer>
            <p>Ứng dụng Nhận Diện Khuôn Mặt &copy; 2023 | Powered by Face-API.js</p>
        </footer>
    </div>

    <script>
        // --- CẤU HÌNH & BIẾN TOÀN CỤC ---
        const video = document.getElementById('video');
        const overlay = document.getElementById('overlay');
        const overlayCtx = overlay.getContext('2d');
        const statusElement = document.getElementById('status');
        const resultsContainer = document.getElementById('resultsContainer');
        const faceCountElement = document.getElementById('faceCount');
        const fpsCounterElement = document.getElementById('fpsCounter');
        
        let isDetecting = false;
        let modelsLoaded = false;
        let frameCount = 0;
        let lastFpsUpdate = Date.now();
        let detectInterval;

        const options = {
            showLandmarks: true,
            showBoxes: true,
            showExpressions: true,
            minConfidence: 0.5
        };

        // --- HÀM CẬP NHẬT TRẠNG THÁI ---
        function updateStatus(msg, type = 'loading') {
            const icon = statusElement.querySelector('i');
            statusElement.querySelector('span').textContent = msg;
            statusElement.className = `status status-${type}`;
            if(type === 'loading') icon.className = 'fas fa-sync-alt fa-spin';
            else if(type === 'ready') icon.className = 'fas fa-check-circle';
            else if(type === 'error') icon.className = 'fas fa-exclamation-circle';
        }

        // --- TẢI MÔ HÌNH (QUAN TRỌNG) ---
        async function loadModels() {
            try {
                updateStatus('Đang tải mô hình AI...', 'loading');
                const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights/';
                
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                    faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL),
                    faceapi.nets.ageGenderNet.loadFromUri(MODEL_URL)
                ]);

                modelsLoaded = true;
                updateStatus('Sẵn sàng! Hãy bấm Bắt đầu', 'ready');
                document.getElementById('startButton').disabled = false;
            } catch (err) {
                console.error(err);
                updateStatus('Lỗi tải mô hình (Kiểm tra mạng)', 'error');
            }
        }

        // --- KHỞI ĐỘNG CAMERA ---
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640 } });
                video.srcObject = stream;
                return new Promise(resolve => video.onloadedmetadata = resolve);
            } catch (err) {
                updateStatus('Không thể truy cập Camera', 'error');
                console.error(err);
            }
        }

        // --- XỬ LÝ NHẬN DIỆN (ĐÃ SỬA LỖI LOGIC) ---
        async function detectFaces() {
            if (!isDetecting) return;

            // 1. Chuẩn bị canvas
            const displaySize = { width: video.videoWidth, height: video.videoHeight };
            if(displaySize.width === 0) { requestAnimationFrame(detectFaces); return; } // Đợi video load xong
            
            faceapi.matchDimensions(overlay, displaySize);

            // 2. Nhận diện (Fluent API - 1 lệnh duy nhất)
            // SỬA LỖI: Sử dụng TinyFaceDetectorOptions đúng cách để tránh lỗi backend
            const detections = await faceapi.detectAllFaces(
                video, 
                new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: options.minConfidence })
            )
            .withFaceLandmarks()
            .withFaceExpressions()
            .withAgeAndGender();

            // 3. Resize kết quả
            const resizedDetections = faceapi.resizeResults(detections, displaySize);

            // 4. Vẽ lên canvas
            overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
            
            if (resizedDetections.length > 0) {
                if(options.showBoxes) faceapi.draw.drawDetections(overlay, resizedDetections);
                if(options.showLandmarks) faceapi.draw.drawFaceLandmarks(overlay, resizedDetections);
                if(options.showExpressions) faceapi.draw.drawFaceExpressions(overlay, resizedDetections);

                // Vẽ tuổi/giới tính
                resizedDetections.forEach(result => {
                    const { age, gender, detection } = result;
                    const text = `${gender === 'male' ? 'Nam' : 'Nữ'}, ${Math.round(age)} tuổi`;
                    const box = detection.box;
                    const drawBox = new faceapi.draw.DrawBox(box, { label: text });
                    drawBox.draw(overlay);
                });
            }

            // 5. Cập nhật UI
            updateStats(resizedDetections);
            
            // Loop tiếp theo
            setTimeout(() => requestAnimationFrame(detectFaces), 50); // Delay nhỏ để đỡ lag
        }

        function updateStats(results) {
            // FPS
            frameCount++;
            const now = Date.now();
            if (now - lastFpsUpdate >= 1000) {
                fpsCounterElement.textContent = Math.round((frameCount * 1000) / (now - lastFpsUpdate));
                frameCount = 0;
                lastFpsUpdate = now;
            }
            faceCountElement.textContent = results.length;

            // Render danh sách kết quả bên phải
            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="no-faces"><p>Không thấy khuôn mặt</p></div>';
                return;
            }

            let html = '';
            results.forEach((res, i) => {
                const expr = res.expressions.asSortedArray()[0];
                const gender = res.gender === 'male' ? 'Nam' : 'Nữ';
                const age = Math.round(res.age);
                const score = (res.detection.score * 100).toFixed(0);
                
                // Dịch biểu cảm
                const expMap = { neutral: 'Bình thường', happy: 'Vui vẻ', sad: 'Buồn', angry: 'Giận', fearful: 'Sợ', disgusted: 'Ghê', surprised: 'Ngạc nhiên' };
                const expText = expMap[expr.expression] || expr.expression;

                html += `
                <div class="face-card">
                    <div class="face-id">Mặt #${i + 1} (${score}%)</div>
                    <div class="face-details">
                        <div class="face-detail"><span class="detail-label">Tuổi:</span> <span class="detail-value">${age}</span></div>
                        <div class="face-detail"><span class="detail-label">Giới tính:</span> <span class="detail-value">${gender}</span></div>
                        <div class="face-detail"><span class="detail-label">Biểu cảm:</span> <span class="detail-value">${expText}</span></div>
                    </div>
                </div>`;
            });
            resultsContainer.innerHTML = html;
        }

        // --- SỰ KIỆN NÚT BẤM ---
        document.getElementById('startButton').addEventListener('click', async () => {
            if(!modelsLoaded) return;
            await startCamera();
            isDetecting = true;
            document.getElementById('startButton').disabled = true;
            document.getElementById('stopButton').disabled = false;
            updateStatus('Đang nhận diện...', 'ready');
            detectFaces();
        });

        document.getElementById('stopButton').addEventListener('click', () => {
            isDetecting = false;
            if(video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
            document.getElementById('startButton').disabled = false;
            document.getElementById('stopButton').disabled = true;
            updateStatus('Đã dừng', 'ready');
        });

        document.getElementById('captureButton').addEventListener('click', () => {
            if(!isDetecting) { alert('Hãy bật camera trước!'); return; }
            const cvs = document.createElement('canvas');
            cvs.width = video.videoWidth; cvs.height = video.videoHeight;
            const ctx = cvs.getContext('2d');
            ctx.drawImage(video, 0, 0);
            ctx.drawImage(overlay, 0, 0); // Vẽ cả lớp phủ
            const a = document.createElement('a');
            a.href = cvs.toDataURL();
            a.download = `photo_${Date.now()}.png`;
            a.click();
        });

        // Checkbox events
        document.getElementById('showLandmarks').onchange = e => options.showLandmarks = e.target.checked;
        document.getElementById('showBoxes').onchange = e => options.showBoxes = e.target.checked;
        document.getElementById('showExpressions').onchange = e => options.showExpressions = e.target.checked;

        // Khởi chạy
        document.getElementById('startButton').disabled = true;
        document.getElementById('stopButton').disabled = true;
        loadModels();

    </script>
</body>
</html>
