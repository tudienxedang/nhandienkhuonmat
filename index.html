<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Data Pro - Enterprise</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <style>
        :root {
            --primary: #0A84FF;
            --success: #30D158;
            --warning: #FF9F0A;
            --danger: #FF453A;
            --bg: #000;
            --surface: #1C1C1E;
            --input-bg: #2C2C2E;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background: var(--bg); color: #fff; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- 1. REGISTRATION MODAL --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 5000;
            display: flex; align-items: center; justify-content: center;
        }
        
        .reg-form {
            background: var(--surface); width: 90%; max-width: 450px; padding: 30px; border-radius: 20px;
            border: 1px solid #333; box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: slideUp 0.4s ease;
        }

        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .form-title { font-size: 24px; font-weight: 700; margin-bottom: 20px; text-align: center; color: var(--primary); }
        
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 13px; color: #888; margin-bottom: 5px; font-weight: 600; }
        .form-input, .form-select {
            width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid #444;
            color: #fff; border-radius: 10px; font-size: 16px; outline: none; transition: 0.2s;
        }
        .form-input:focus, .form-select:focus { border-color: var(--primary); background: #333; }
        .form-input[readonly] { opacity: 0.6; cursor: not-allowed; font-family: monospace; letter-spacing: 1px; }

        .row { display: flex; gap: 15px; }
        .col { flex: 1; }

        .btn-start {
            width: 100%; padding: 15px; background: var(--primary); color: white; border: none;
            border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px;
            transition: 0.2s;
        }
        .btn-start:hover { background: #0070e0; transform: scale(1.02); }

        /* --- 2. MAIN APP UI --- */
        header {
            height: 60px; background: rgba(28,28,30,0.9); display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; border-bottom: 1px solid #333; z-index: 100;
        }
        .user-info-pill { font-size: 13px; background: #333; padding: 5px 10px; border-radius: 15px; color: #ccc; }

        .viewport { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; background: #000; }
        video { position: absolute; min-width: 100%; min-height: 100%; object-fit: cover; transform: scaleX(-1); }

        /* Face Guide */
        .guide-box {
            position: absolute; width: 280px; height: 380px; border-radius: 50% / 40%;
            border: 3px solid rgba(255,255,255,0.2); box-shadow: 0 0 0 9999px rgba(0,0,0,0.85);
            transition: 0.3s; display: flex; justify-content: center;
        }
        .guide-box.active { border-color: var(--success); box-shadow: 0 0 0 9999px rgba(0,0,0,0.6); }
        .guide-box.error { border-color: var(--warning); }

        .msg-box { position: absolute; top: -70px; text-align: center; width: 100%; text-shadow: 0 2px 5px #000; }
        .main-msg { font-size: 22px; font-weight: 700; display: block; margin-bottom: 5px; }
        .sub-msg { font-size: 14px; color: #ccc; }

        /* Controls */
        .controls {
            position: absolute; bottom: 0; width: 100%; padding: 30px; background: linear-gradient(transparent, #000);
            display: flex; justify-content: center; gap: 40px; align-items: center;
        }
        .shutter {
            width: 75px; height: 75px; border-radius: 50%; border: 4px solid #fff; background: transparent;
            position: relative; cursor: pointer; transition: 0.2s;
        }
        .shutter::after { content: ''; position: absolute; inset: 5px; background: #fff; border-radius: 50%; transition: 0.2s; }
        .shutter:active::after { background: var(--success); transform: scale(0.9); }
        .shutter:disabled { opacity: 0.3; cursor: not-allowed; }

        .manual-btn { background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 10px 15px; border-radius: 20px; cursor: pointer; font-size: 12px; }
        .manual-btn.active { background: var(--danger); }

        /* Debug Bars */
        .debug-panel { position: absolute; bottom: 120px; display: flex; gap: 8px; background: rgba(0,0,0,0.5); padding: 8px; border-radius: 8px; }
        .bar { width: 50px; height: 4px; background: #555; position: relative; }
        .fill { width: 8px; height: 8px; background: var(--primary); position: absolute; top: -2px; border-radius: 50%; transition: 0.1s; }

        /* Flash */
        .flash { position: fixed; inset: 0; background: #fff; opacity: 0; pointer-events: none; z-index: 9999; }
        .flash.fire { animation: flash 0.2s ease-out; }
        @keyframes flash { 0% { opacity: 0.8; } 100% { opacity: 0; } }

        /* --- LOADING OVERLAY CHO UPLOAD --- */
        .loader-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 6000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #333; border-top-color: var(--primary);
            border-radius: 50%; animation: spin 1s infinite linear;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="loader-overlay" id="uploadLoader">
        <div class="spinner"></div>
        <h3 style="margin-top: 20px;">Đang gửi dữ liệu lên Google Drive...</h3>
        <p style="color: #888; margin-top: 10px;">Vui lòng không tắt trình duyệt</p>
    </div>

    <div class="modal-overlay" id="regModal">
        <div class="reg-form">
            <div class="form-title"><i class="fas fa-user-shield"></i> Thông tin đối tượng</div>
            
            <div class="form-group">
                <label class="form-label">Mã ID (Tự động)</label>
                <input type="text" id="userId" class="form-input" readonly>
            </div>

            <div class="form-group">
                <label class="form-label">Họ và Tên</label>
                <input type="text" id="fullName" class="form-input" placeholder="VD: Nguyễn Văn A">
            </div>

            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label class="form-label">Giới tính</label>
                        <select id="gender" class="form-select">
                            <option value="Nam">Nam</option>
                            <option value="Nữ">Nữ</option>
                            <option value="Khác">Khác</option>
                        </select>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label class="form-label">Lớp / Đơn vị</label>
                        <input type="text" id="userClass" class="form-input" placeholder="VD: 12A1">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Dân tộc</label>
                <input type="text" id="ethnicity" class="form-input" placeholder="VD: Kinh">
            </div>

            <button class="btn-start" onclick="submitRegistration()">
                <i class="fas fa-camera"></i> Xác nhận & Bắt đầu
            </button>
            <div id="loadingModelMsg" style="text-align: center; margin-top: 10px; font-size: 12px; color: #888;">
                <i class="fas fa-spinner fa-spin"></i> Đang tải AI Model ngầm...
            </div>
        </div>
    </div>

    <div class="flash" id="flashInfo"></div>
    
    <header>
        <div style="font-weight: 700;">Face Data Pro</div>
        <div class="user-info-pill" id="headerUserInfo">Chưa đăng nhập</div>
        <button class="manual-btn" id="exportBtn" style="background: var(--success); opacity: 0.5;" disabled>
            <i class="fab fa-google-drive"></i> Lưu Drive
        </button>
    </header>

    <div class="viewport">
        <video id="video" autoplay muted playsinline></video>
        
        <div class="guide-box" id="guideRing">
            <div class="msg-box">
                <span class="main-msg" id="mainMsg" style="color: var(--primary)">CENTER</span>
                <span class="sub-msg" id="subMsg">0/3</span>
            </div>
        </div>

        <div class="debug-panel">
            <div class="bar" title="Yaw"><div class="fill" id="yawFill" style="left: 50%"></div></div>
            <div class="bar" title="Pitch"><div class="fill" id="pitchFill" style="left: 50%"></div></div>
        </div>
    </div>

    <div class="controls">
        <button class="manual-btn" id="manualToggle">Thủ công</button>
        <button class="shutter" id="shutterBtn" disabled></button>
        <div style="width: 60px; height: 60px; border-radius: 10px; overflow: hidden; border: 2px solid #fff; background: #333;">
            <img id="lastThumb" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.6;">
        </div>
    </div>

    <script>
        // --- QUAN TRỌNG: DÁN URL CỦA BẠN VÀO ĐÂY ---
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyKP16d1dEwmclrnrc8_np9vFXFl1rOpQV3NWkQdOpAx_wfLsyGu-FthsHL8I7XQkw8kg/exec';
        // ------------------------------------------

        // --- CẤU HÌNH ---
        const MODEL_URL = 'https://cdn.jsdelivr.net/gh/cgarciagl/face-api.js@0.22.2/weights';
        const CONFIG = {
            ANGLES: ['center', 'left', 'right', 'up', 'down'],
            PHOTOS_PER_ANGLE: 3,
            SENSITIVITY: 0.35
        };

        // --- STATE ---
        let state = {
            user: { id: '', name: '', gender: '', class: '', ethnicity: '' },
            angleIdx: 0,
            photoCount: 0,
            images: [], // { name, blob }
            metadata: [],
            isManual: false,
            canCapture: false,
            lastDetection: null,
            modelsReady: false
        };

        const el = (id) => document.getElementById(id);
        
        window.onload = function() {
            const randomStr = Math.random().toString(36).substring(2, 7).toUpperCase();
            state.user.id = `ID_${randomStr}_${new Date().getFullYear()}`;
            el('userId').value = state.user.id;
            loadModels();
        };

        async function loadModels() {
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                state.modelsReady = true;
                el('loadingModelMsg').innerHTML = '<span style="color:var(--success)">AI Sẵn sàng!</span>';
            } catch (e) {
                console.error(e);
                el('loadingModelMsg').innerText = 'Lỗi tải AI. Vui lòng F5.';
            }
        }

        function submitRegistration() {
            const name = el('fullName').value.trim();
            const cls = el('userClass').value.trim();
            const gender = el('gender').value;
            const eth = el('ethnicity').value.trim();

            if (!name || !cls || !eth) {
                alert("Vui lòng nhập đầy đủ thông tin!");
                return;
            }

            state.user.name = name;
            state.user.class = cls;
            state.user.gender = gender;
            state.user.ethnicity = eth;

            el('headerUserInfo').innerText = `${state.user.id} | ${name}`;
            el('regModal').style.display = 'none';

            startCameraAndAI();
        }

        async function startCameraAndAI() {
            const constraints = [
                { video: { width: 1280, height: 720, facingMode: 'user' } },
                { video: { width: 640, height: 480, facingMode: 'user' } },
                { video: true }
            ];

            let stream = null;
            for (let c of constraints) {
                try {
                    stream = await navigator.mediaDevices.getUserMedia(c);
                    break;
                } catch (e) {}
            }

            if (!stream) {
                alert("Không thể bật Camera. Hãy kiểm tra quyền truy cập.");
                return;
            }

            el('video').srcObject = stream;
            el('video').onloadedmetadata = () => {
                el('video').play();
                startAILoop();
            };
        }

        function startAILoop() {
            const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });
            
            setInterval(async () => {
                if (!state.modelsReady || state.isManual) return;

                const detection = await faceapi.detectSingleFace(el('video'), options)
                    .withFaceLandmarks(true)
                    .withFaceDescriptor();

                if (detection) {
                    const pose = calcPose(detection.landmarks);
                    updateDebug(pose);
                    checkPose(pose, detection.detection.score);
                    state.lastDetection = detection;
                } else {
                    updateStatus(false, "Không tìm thấy mặt", true);
                }
            }, 100);
        }

        function calcPose(landmarks) {
            const nose = landmarks.getNose()[3];
            const leftEye = landmarks.getLeftEye()[0];
            const rightEye = landmarks.getRightEye()[3];
            const width = Math.hypot(rightEye.x - leftEye.x, rightEye.y - leftEye.y);
            const midX = (leftEye.x + rightEye.x) / 2;
            const midY = (leftEye.y + rightEye.y) / 2;
            const yaw = ((nose.x - midX) / width) * -2.5; 
            const pitch = ((nose.y - midY) / width - 0.4) * 2.0;

            return { yaw, pitch };
        }

        function checkPose(pose, score) {
            const target = CONFIG.ANGLES[state.angleIdx];
            const T = CONFIG.SENSITIVITY;
            let ok = false;
            let msg = "";

            if (score < 0.45) { updateStatus(false, "Mặt mờ", true); return; }

            switch(target) {
                case 'center': ok = Math.abs(pose.yaw) < T && Math.abs(pose.pitch) < T; msg = "Nhìn thẳng"; break;
                case 'left': ok = pose.yaw < -0.2; msg = "Quay TRÁI"; break;
                case 'right': ok = pose.yaw > 0.2; msg = "Quay PHẢI"; break;
                case 'up': ok = pose.pitch < -0.15; msg = "Ngẩng LÊN"; break;
                case 'down': ok = pose.pitch > 0.15; msg = "Cúi XUỐNG"; break;
            }

            updateStatus(ok, ok ? "Giữ nguyên" : msg, !ok);
        }

        function updateStatus(canCap, text, isErr) {
            state.canCapture = canCap;
            el('shutterBtn').disabled = !canCap;
            el('subMsg').innerText = text;
            el('subMsg').style.color = canCap ? 'var(--success)' : '#ccc';
            
            const ring = el('guideRing');
            if (canCap) ring.className = 'guide-box active';
            else ring.className = isErr ? 'guide-box error' : 'guide-box';
        }

        function updateDebug(pose) {
            const toPct = v => Math.min(Math.max((v+1)/2*100, 0), 100) + '%';
            el('yawFill').style.left = toPct(pose.yaw);
            el('pitchFill').style.left = toPct(pose.pitch);
        }

        el('shutterBtn').addEventListener('click', () => {
            if (!state.canCapture && !state.isManual) return;

            const flash = el('flashInfo');
            flash.classList.remove('fire');
            void flash.offsetWidth;
            flash.classList.add('fire');

            const cvs = document.createElement('canvas');
            cvs.width = el('video').videoWidth;
            cvs.height = el('video').videoHeight;
            const ctx = cvs.getContext('2d');
            ctx.drawImage(el('video'), 0, 0);

            cvs.toBlob(blob => saveData(blob), 'image/jpeg', 0.95);
        });

        function saveData(blob) {
            const angle = CONFIG.ANGLES[state.angleIdx];
            const fname = `${state.user.id}_${angle}_${Date.now()}.jpg`;

            state.images.push({ name: fname, blob: blob });

            const meta = {
                filename: fname,
                angle: angle,
                user_id: state.user.id,
                descriptor: state.lastDetection ? Array.from(state.lastDetection.descriptor) : [],
                landmarks: state.lastDetection ? state.lastDetection.landmarks.positions : []
            };
            state.metadata.push(meta);

            el('lastThumb').src = URL.createObjectURL(blob);
            state.photoCount++;
            el('subMsg').innerText = `${state.photoCount}/${CONFIG.PHOTOS_PER_ANGLE}`;

            if (state.photoCount >= CONFIG.PHOTOS_PER_ANGLE) {
                state.photoCount = 0;
                state.angleIdx++;
                if (state.angleIdx >= CONFIG.ANGLES.length) {
                    finishJob();
                } else {
                    el('mainMsg').innerText = CONFIG.ANGLES[state.angleIdx].toUpperCase();
                }
            }
        }

        function finishJob() {
            el('guideRing').className = 'guide-box active';
            el('mainMsg').innerText = "HOÀN TẤT";
            el('subMsg').innerText = "Sẵn sàng gửi dữ liệu!";
            el('shutterBtn').style.display = 'none';
            el('exportBtn').disabled = false;
            el('exportBtn').style.opacity = 1;
            
            // Tự động nhắc
            if(confirm("Đã thu thập xong! Bạn có muốn gửi dữ liệu lên Google Drive ngay không?")) {
                el('exportBtn').click();
            }
        }

        el('manualToggle').addEventListener('click', function() {
            state.isManual = !state.isManual;
            if (state.isManual) {
                this.classList.add('active');
                updateStatus(true, "Chế độ thủ công", false);
            } else {
                this.classList.remove('active');
                state.canCapture = false;
            }
        });

        // --- TÍNH NĂNG MỚI: UPLOAD LÊN GOOGLE DRIVE ---
        
        // Helper chuyển đổi Blob sang Base64
        const blobToBase64 = (blob) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        };

        el('exportBtn').addEventListener('click', async () => {
            if (!GOOGLE_SCRIPT_URL.startsWith('https')) {
                alert("Bạn chưa dán link Web App của Google Script vào code!");
                return;
            }

            el('uploadLoader').style.display = 'flex'; // Hiện màn hình chờ

            try {
                // 1. Chuyển đổi toàn bộ ảnh sang Base64
                let imagesBase64 = [];
                for (let img of state.images) {
                    let b64 = await blobToBase64(img.blob);
                    imagesBase64.push({
                        name: img.name,
                        data: b64
                    });
                }

                // 2. Tạo gói dữ liệu
                const payload = {
                    user_profile: state.user,
                    collection_date: new Date().toISOString(),
                    total_images: state.images.length,
                    records: state.metadata,
                    images_base64: imagesBase64
                };

                // 3. Gửi lên Google Script
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Bắt buộc để tránh lỗi chặn tên miền chéo
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // Tắt màn hình chờ
                el('uploadLoader').style.display = 'none';
                
                alert("✅ Thành công! Dữ liệu đã được gửi lên Google Drive.");
                
                // Reset để nhập người tiếp theo
                location.reload();

            } catch (error) {
                console.error(error);
                el('uploadLoader').style.display = 'none';
                alert("❌ Lỗi khi gửi: " + error.message);
            }
        });

    </script>
</body>
</html>
